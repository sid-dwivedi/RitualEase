<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Puja Details</title>
    <style>
        #mapModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        #mapContainer {
            position: relative;
            margin: 5% auto;
            width: 80%; height: 80%;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
        }
        #map {
            height: 90%;
            width: 100%;
            border-radius: 8px;
        }
    </style>
    <!-- ‚úÖ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
<h2 th:text="${puja != null} ? ${puja.pujaName} : 'Puja not found'">Puja Name</h2>
<p th:text="${puja.pujaDescription}">Puja Description</p>
<p>
    <b>Price:</b>
    <span th:text="${puja.price}">0</span>
</p>

<div id="location-section">
    <h3>Your Location</h3>
    <button id="currentLocationBtn">Use My Current Location</button>
    <button id="manualLocationBtn">Choose on Map</button>
</div>

<div id="mapModal">
    <div id="mapContainer">
        <div id="map"></div>
        <button id="closeMapBtn">Done</button>
    </div>
</div>
<!-- ‚úÖ Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    const currentBtn = document.getElementById("currentLocationBtn");
 const manualBtn = document.getElementById("manualLocationBtn");
 const mapModal = document.getElementById("mapModal");
 const closeMapBtn = document.getElementById("closeMapBtn");
 let selectedLocation = null;
 let map, marker;

 // ‚úÖ Current location button
 currentBtn.addEventListener("click", () => {
     navigator.geolocation.getCurrentPosition(async (pos) => {
         const lat = pos.coords.latitude;
         const lon = pos.coords.longitude;
         const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
         const data = await res.json();

         selectedLocation = data.display_name;

         // ‚úÖ hidden input me address store karo
         document.getElementById("locationInput").value = selectedLocation;

         // ‚úÖ ab Select button enable hoga
         document.getElementById("selectBtn").disabled = false;

         alert("üìç Location selected: " + selectedLocation);
     });
 });

 // ‚úÖ Manual location button ‚Üí open map
 manualBtn.addEventListener("click", () => {
     mapModal.style.display = "block";
     if (!map) {
         map = L.map('map').setView([20.5937, 78.9629], 5); // Default India
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             attribution: '¬© OpenStreetMap contributors'
         }).addTo(map);

         map.on('click', async function (e) {
             let lat = e.latlng.lat;
             let lon = e.latlng.lng;
             const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
             const data = await res.json();
             if (marker) map.removeLayer(marker);
             marker = L.marker([lat, lon]).addTo(map).bindPopup(data.display_name).openPopup();
             selectedLocation = data.display_name;

             // ‚úÖ hidden input update karo
             document.getElementById("locationInput").value = selectedLocation;

             // ‚úÖ button enable karo
             document.getElementById("selectBtn").disabled = false;
         });
     }
 });

 // ‚úÖ Close map modal
 closeMapBtn.addEventListener("click", () => {
     mapModal.style.display = "none";
     if (selectedLocation) {
         alert("üìç Location selected: " + selectedLocation);
     } else {
         alert("‚ö† Please click somewhere on the map first.");
     }
 });

</script>
<form th:action="@{/pandit/addpuja/{pujaId}(pujaId=${puja.id})}" method="post">
    <input type="hidden" id="locationInput" name="location"/>
    <button type="submit" id="selectBtn" disabled>Select</button>
</form>

</body>
</html>
